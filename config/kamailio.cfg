#!KAMAILIO
#
# InfraFabric SIP Proxy Configuration (IF.ESCALATE)
# ==================================================
#
# Philosophy Grounding:
# - Wu Lun (朋友): SIP peers are equals, external experts invited as peers
# - Popper Falsifiability: External experts provide contrarian views
# - IF.ground Observable: All SIP signaling is logged and auditable
# - IF.TTT: Traceable (X-IF-Trace-ID), Transparent (logs), Trustworthy (TLS+Auth)
#
# Integration:
# - IF.guard: Policy gate via Python hooks
# - IF.witness: Complete audit logging
# - Session 3 (H.323): Route to H323_BRIDGE for Guardian council
# - Session 2 (WebRTC): Evidence sharing via DataChannel
#
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 InfraFabric

####### Global Parameters #########

# --- Debugging ---
debug=3
log_stderror=yes
memdbg=5
memlog=5

# --- Network Settings ---
listen=udp:0.0.0.0:5060
listen=tcp:0.0.0.0:5060
# TLS for production (Phase 2)
# listen=tls:0.0.0.0:5061

# --- Process Settings ---
children=4
tcp_children=4

# --- Module Loading ---
loadmodule "tm.so"          # Transaction module
loadmodule "sl.so"          # Stateless replies
loadmodule "rr.so"          # Record-Route
loadmodule "pv.so"          # Pseudo-variables
loadmodule "maxfwd.so"      # Max-Forward header check
loadmodule "textops.so"     # Text operations
loadmodule "siputils.so"    # SIP utilities
loadmodule "xlog.so"        # Enhanced logging
loadmodule "sanity.so"      # SIP message sanity checks
loadmodule "app_python3.so" # Python 3 integration for IF.guard policy

# TLS module (Phase 2)
# loadmodule "tls.so"

# --- Module Parameters ---

# Python integration
modparam("app_python3", "load", "/home/user/infrafabric/src/communication/sip_proxy.py")
modparam("app_python3", "script_name", "sip_proxy")

# Transaction module
modparam("tm", "fr_timer", 2000)
modparam("tm", "fr_inv_timer", 40000)

# Record-Route module
modparam("rr", "enable_full_lr", 1)
modparam("rr", "append_fromtag", 1)

####### Routing Logic ########

# Main SIP request routing block
request_route {
    # Initial sanity checks
    route(SANITY_CHECK);

    # IF.witness logging: Log all incoming requests
    xlog("L_INFO", "[IF.witness] SIP $rm from $fu to $ru (Call-ID: $ci)\n");

    # Max-Forward check (loop prevention)
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    # Check if this is an INVITE for external expert call
    if (is_method("INVITE")) {
        route(IF_ESCALATE_INVITE);
    }

    # Handle in-dialog requests
    if (has_totag()) {
        route(IN_DIALOG);
    }

    # Record-Route for all requests
    if (!is_method("REGISTER")) {
        record_route();
    }

    # Forward to destination
    route(FORWARD);
}

# IF.ESCALATE INVITE handling
route[IF_ESCALATE_INVITE] {
    xlog("L_INFO", "[IF.ESCALATE] Processing INVITE from $fu to $ru\n");

    # Extract custom IF headers
    $var(trace_id) = $hdr(X-IF-Trace-ID);
    $var(hazard) = $hdr(X-IF-Hazard);
    $var(signature) = $hdr(X-IF-Signature);

    # Validate required IF headers
    if (!$var(trace_id) || !$var(hazard)) {
        xlog("L_WARN", "[IF.ESCALATE] Missing required IF headers (X-IF-Trace-ID or X-IF-Hazard)\n");
        sl_send_reply("400", "Bad Request - Missing IF headers");
        exit;
    }

    xlog("L_INFO", "[IF.guard] Checking policy: trace_id=$var(trace_id), hazard=$var(hazard)\n");

    # Call Python hook for IF.guard policy check
    if (!python_exec("check_policy")) {
        xlog("L_WARN", "[IF.guard] Policy REJECTED: trace_id=$var(trace_id)\n");
        sl_send_reply("403", "Forbidden - IF.guard policy rejected");
        exit;
    }

    xlog("L_INFO", "[IF.guard] Policy APPROVED: trace_id=$var(trace_id)\n");

    # Check if destination is external expert
    if ($ru =~ "sip:expert-.*@external.advisor") {
        xlog("L_INFO", "[IF.ESCALATE] Routing to external expert: $ru\n");
        route(EXTERNAL_EXPERT);
        exit;
    }

    # Route to H.323 gateway for Guardian council bridge
    route(H323_BRIDGE);
}

# External expert routing
route[EXTERNAL_EXPERT] {
    xlog("L_INFO", "[EXTERNAL] Routing to external expert: $ru\n");

    # Add Record-Route with custom parameters for IF.witness
    record_route_preset("0.0.0.0:5060", "trace=$var(trace_id)");

    # IF.witness: Log external expert INVITE
    xlog("L_INFO", "[IF.witness] INVITE to external expert $ru (trace: $var(trace_id))\n");

    # Forward to external expert
    # In production, this would route to actual external SIP infrastructure
    t_relay();
}

# H.323 Gateway bridge (Session 3 integration)
route[H323_BRIDGE] {
    xlog("L_INFO", "[H323_BRIDGE] Routing to H.323 Gateway for Guardian council\n");

    # Rewrite Request-URI to H.323 gateway endpoint
    # In production, this would be the actual H.323 gateway IP:port
    $ru = "sip:h323-gateway@127.0.0.1:5062";

    # Add custom header for H.323 gateway to identify source
    append_hf("X-IF-Source: SIP-External-Expert\r\n");
    append_hf("X-IF-Bridge-Mode: SIP-to-H323\r\n");

    # IF.witness: Log H.323 bridge routing
    xlog("L_INFO", "[IF.witness] Bridging to H.323: trace=$var(trace_id)\n");

    # Forward to H.323 gateway
    t_relay();
}

# In-dialog request handling
route[IN_DIALOG] {
    # Handle sequential requests within dialog
    if (!loose_route()) {
        if (is_method("ACK")) {
            if (t_check_trans()) {
                route(FORWARD);
                exit;
            } else {
                # ACK without matching transaction - ignore and discard
                exit;
            }
        }
        sl_send_reply("404", "Not here");
        exit;
    }

    # IF.witness: Log in-dialog requests
    xlog("L_INFO", "[IF.witness] In-dialog $rm (Call-ID: $ci)\n");

    route(FORWARD);
}

# Forward request
route[FORWARD] {
    if (!t_relay()) {
        sl_reply_error();
    }
}

# Sanity checks
route[SANITY_CHECK] {
    if (!sanity_check()) {
        xlog("L_WARN", "[SANITY] Malformed SIP message from $si:$sp\n");
        exit;
    }
}

####### Response Handling ########

onreply_route {
    # IF.witness: Log all responses
    xlog("L_INFO", "[IF.witness] SIP response $rs $rr (Call-ID: $ci)\n");

    # Handle specific response codes
    if (status =~ "^[12][0-9][0-9]$") {
        # Success responses (1xx, 2xx)
        xlog("L_INFO", "[IF.ESCALATE] Success response: $rs $rr\n");
    } else if (status =~ "^[4-6][0-9][0-9]$") {
        # Error responses (4xx, 5xx, 6xx)
        xlog("L_WARN", "[IF.ESCALATE] Error response: $rs $rr\n");
    }
}

####### Failure Handling ########

failure_route {
    xlog("L_WARN", "[FAILURE] Transaction failed: $ci\n");

    # IF.witness: Log failure
    xlog("L_WARN", "[IF.witness] Call failed: trace=$hdr(X-IF-Trace-ID)\n");

    # Could implement retry logic here in production
    # For now, just log and fail
}

####### Configuration Notes ########

# External Expert Registry:
# -------------------------
# Approved external experts (managed by IF.guard policy):
#   - sip:expert-safety@external.advisor     (Safety & Alignment)
#   - sip:expert-ethics@external.advisor     (Ethics & Bias)
#   - sip:expert-security@external.advisor   (Security & Privacy)
#
# Add new experts by updating IF.guard policy in src/communication/sip_proxy.py

# H.323 Gateway Endpoint:
# -----------------------
# Default: sip:h323-gateway@127.0.0.1:5062
# In production, update route[H323_BRIDGE] with actual H.323 gateway address

# IF.witness Logging:
# ------------------
# All SIP events are logged with xlog for IF.witness audit trail:
#   - INVITE, ACK, BYE (call control)
#   - Responses (1xx, 2xx, 4xx, 5xx, 6xx)
#   - Policy decisions (approved/rejected)
#   - H.323 bridge events
#
# Logs include:
#   - Call-ID (SIP standard)
#   - X-IF-Trace-ID (IF correlation)
#   - Source/Destination URIs
#   - Response codes

# Phase 2 Security (TODO):
# ------------------------
# 1. Enable TLS (port 5061)
# 2. Load tls.so module
# 3. Configure certificate paths
# 4. Add digest authentication
# 5. Implement rate limiting
# 6. Add IP allowlist

# Prometheus Metrics Export (Phase 2):
# ------------------------------------
# Use kamailio-exporter or custom xHTTP module to expose:
#   - sip_calls_total
#   - sip_call_duration_seconds
#   - sip_errors_total
#   - sip_policy_decisions_total{result="approved|rejected"}
