# Grafana Loki Configuration
# Purpose: Centralized log aggregation, indexing, and querying for InfraFabric
# Reference: https://grafana.com/docs/loki/latest/configuration/
#
# if://config/loki/2025-11-30
#
# Deployment: Single-instance Loki suitable for <100M logs/day
# For higher volume, use distributed deployment with microservices mode

auth_enabled: false

# Ingester configuration
ingester:
  chunk_idle_period: 3m
  chunk_retain_period: 1m
  max_chunk_age: 1h
  max_streams_per_user: 10000
  chunk_encoding: snappy
  # Rate limiting per distributor
  rate_limit_utilization: 0.95
  rate_limit_bytes: 100MB

# Schema configuration - defines how logs are indexed
schema_config:
  configs:
    # InfraFabric logs schema (v12 - current)
    - from: "2025-11-30"
      store: boltdb-shipper
      object_store: filesystem
      schema: v12
      index:
        prefix: infrafabric_
        period: 24h

        # Labels - cardinality controls for efficient indexing
        # These become dimensions for log queries
        tags:
          - agent_id
          - component
          - level
          - correlation_id
          - swarm_id
          - environment
          - service

# Server configuration
server:
  http_listen_port: 3100
  http_server_read_timeout: 600s
  http_server_write_timeout: 600s
  # gRPC listener for distributed setup
  grpc_listen_port: 9096
  log_level: info
  # Log format: json for structured logging
  log_format: json

# Limits configuration - prevent runaway queries/ingestion
limits_config:
  # Ingestion rate limits
  rate_limit_bytes: 100MB
  max_bytes_per_second: 10MB
  max_global_streams_per_user: 100000

  # Query limits
  max_entries_limit_per_second: 1000
  max_query_lookback: 720h  # 30 days
  max_query_length: 721h    # 30+ days
  max_query_parallelism: 32

  # Enforce label cardinality (prevent DoS via high-cardinality labels)
  cardinality_limit: 100000
  cardinality_limit_bytes: 0

  # Enforce retention
  retention_period: 720h  # 30 days hot storage
  retention_stream:
    - selector: '{level="ERROR"}'
      days: 90  # Keep errors longer
    - selector: '{level="FATAL"}'
      days: 365  # Keep fatal errors 1 year
    - selector: '{severity="critical"}'
      days: 365  # Keep critical events 1 year

# Period configuration
period_config:
  max_global_streams_per_user: 100000
  max_global_stream_match_bytes_per_user: 100GB
  split_queries_by_interval: 24h

# Runtime configuration
runtime_config:
  # Allows dynamic config updates without restart
  file: /etc/loki/runtime.yaml
  period: 10s

# Storage configuration
storage_config:
  # BoltDB + local filesystem (suitable for single-instance)
  boltdb_shipper:
    active_index_directory: /loki/boltdb-shipper-active
    cache_location: /loki/boltdb-shipper-cache
    shared_store: filesystem
    # Caching for faster searches
    index_cache_validity: 5m

  # Filesystem storage backend
  filesystem:
    directory: /loki/chunks

  # Caching layer for better performance
  cache_config:
    enable_fifocache: true
    default_validity: 1h
    background:
      writeback_goroutines: 10
      writeback_delay: 5s

  # Optional: Remote storage (S3-compatible for retention)
  # Uncomment if using distributed Loki
  # aws:
  #   s3: s3://minio:minio123@minio:9000/loki
  #   s3forcepathstyle: true
  #   endpoint: http://minio:9000
  #   region: us-east-1

# Querier configuration - controls log searches
querier:
  max_concurrent: 20
  max_samples: 1000000000
  query_ingesters_within: 3h
  # Use labels for splitting large queries
  split_queries_by_interval: 24h
  # Cache query results
  cache_results: true
  max_cache_freshness_per_query: 10m
  # Timeout for queries
  timeout: 5m

# Query frontend - sits in front of querier
query_frontend:
  max_cache_freshness_per_query: 10m
  # Compress responses for bandwidth savings
  compress_responses: true
  log_queries_longer_than: 10s
  downstream_url: http://localhost:3100
  # Cache configuration
  cache_results: true

# Distributor configuration - receives and distributes logs
distributor:
  ring:
    kvstore:
      store: inmemory
    replication_factor: 1

  # Rate limiting
  rate_limiting_enabled: true
  rate_limit_bytes: 100MB
  rate_limit_enabled: true

# Memberlist for cluster coordination (not needed for single-instance)
# memberlist:
#   node_name: loki-01
#   retransmit_factor: 4
#   dead_node_reclaim_time: 30s

# Analytics configuration
analytics:
  reporting_enabled: false

# Tracing configuration - optional for distributed tracing integration
tracing:
  enabled: false
  # If enabled, send traces to Jaeger or Tempo
  # jaeger:
  #   endpoint: http://jaeger:14268/api/traces

# Compactor configuration - manages log chunks
compactor:
  working_directory: /loki/compactor
  compaction_interval: 10m
  max_compaction_parallelism: 4
  # Retention enforcement
  retention_enabled: true
  retention_delete_delay: 2h
  retention_delete_worker_count: 10

# Ruler configuration - alert on log patterns (optional)
# Uncomment to enable alerting
# ruler:
#   alertmanager_url: http://alertmanager:9093
#   rule_path: /loki/rules
#   evaluation_interval: 1m
#   poll_interval: 1m
#   rules_path: /etc/loki/rules
#   enable_api: true
#   enable_alertmanager_discovery: true
