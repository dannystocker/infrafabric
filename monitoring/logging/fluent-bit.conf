# Fluent Bit Configuration for InfraFabric Distributed Logging
# Purpose: Lightweight log collector for all agents and services
# Deploys on each agent node, aggregates to centralized Loki or Elasticsearch
#
# if://config/fluent-bit/2025-11-30

[SERVICE]
    # Fluent Bit Service Configuration
    Daemon                      Off
    Flush                       5
    Log_Level                   info
    Parsers_File                parsers.conf
    Plugins_File                plugins.conf
    HTTP_Server                 On
    HTTP_Listen                 0.0.0.0
    HTTP_Port                   2020
    Health_Check                On
    HC_Errors_Count             5
    HC_Retry_Failure_Count      5
    HC_Period                   60
    Metrics_URL                 /api/v1/metrics
    Meta_path                   /var/fluent-bit/meta.db
    # Token efficiency: Haiku compatibility mode (lightweight)
    Parsers_File                parsers.conf


# =============================================================================
# INPUT SOURCES
# =============================================================================

# InfraFabric Agent Logs (JSON)
[INPUT]
    Name                        tail
    Path                        /var/log/infrafabric/agents/*.log
    Parser                      json
    Tag                         agent.*
    Refresh_Interval            5
    Mem_Buf_Limit               5MB
    Skip_Long_Lines             On
    Skip_Empty_Lines            On
    DB                          /var/lib/fluent-bit/agent.db
    DB.Locking                  true
    Read_from_Head              On
    # Correlation ID extraction
    Extract_Metadata            true
    # Support for multi-line logs (stack traces)
    Multiline                   On
    Multiline_Flush             5


# InfraFabric Agent Logs - Alternate Path
[INPUT]
    Name                        tail
    Path                        /home/setup/infrafabric/logs/*.log
    Parser                      json
    Tag                         agent.local
    Refresh_Interval            5
    Mem_Buf_Limit               5MB
    Skip_Long_Lines             On
    DB                          /var/lib/fluent-bit/agent-local.db
    DB.Locking                  true


# Redis Logs
[INPUT]
    Name                        tail
    Path                        /var/log/redis/redis.log
    Parser                      redis_log
    Tag                         redis.*
    Refresh_Interval            5
    Mem_Buf_Limit               2MB
    DB                          /var/lib/fluent-bit/redis.db
    DB.Locking                  true


# ChromaDB Logs
[INPUT]
    Name                        tail
    Path                        /var/log/chromadb/*.log
    Parser                      json
    Tag                         chromadb.*
    Refresh_Interval            5
    Mem_Buf_Limit               2MB
    DB                          /var/lib/fluent-bit/chromadb.db
    DB.Locking                  true


# OpenWebUI/API Access Logs
[INPUT]
    Name                        tail
    Path                        /var/log/openwebui/access.log
    Parser                      apache2
    Tag                         api.access
    Refresh_Interval            5
    Mem_Buf_Limit               5MB
    DB                          /var/lib/fluent-bit/api.db
    DB.Locking                  true


# System Logs (journald)
[INPUT]
    Name                        systemd
    Tag                         system.*
    Systemd_Filter              _SYSTEMD_UNIT=infrafabric*
    Systemd_Filter              _SYSTEMD_UNIT=redis*
    Read_From_Tail              On
    Refresh_Interval            5
    Strip_Underscores           On
    DB                          /var/lib/fluent-bit/system.db
    DB.Locking                  true


# Application Metrics (optional - for performance monitoring)
[INPUT]
    Name                        cpu
    Tag                         metrics.cpu
    Interval_Sec                30
    Interval_Nsec               0

[INPUT]
    Name                        mem
    Tag                         metrics.memory
    Interval_Sec                30
    Interval_Nsec               0


# =============================================================================
# FILTERS - Enrich & Transform Logs
# =============================================================================

# Extract Correlation ID from message if not present
[FILTER]
    Name                        modify
    Match                       agent.*
    # If correlation_id not in JSON, try to extract from message
    Rule                        "add correlation_id ${RANDOM_UUID}" if missing


# Add hostname/node information
[FILTER]
    Name                        record_modifier
    Match                       *
    Record                      hostname ${HOSTNAME}
    Record                      service infrafabric
    Record                      version 1.0.0


# Parse JSON and ensure schema compliance
[FILTER]
    Name                        modify
    Match                       agent.*
    # Ensure required fields present
    Condition                   Key_value_matches timestamp .*
    Rule                        "add timestamp ${TIMESTAMP}" if missing


# Add environment context
[FILTER]
    Name                        modify
    Match                       agent.*
    Record                      environment ${ENVIRONMENT:-development}


# Rate limit protection (don't overwhelm downstream)
[FILTER]
    Name                        throttle
    Match                       agent.*
    Rate                        1000
    Window                      5
    Print_Status                true


# Metrics enrichment
[FILTER]
    Name                        record_modifier
    Match                       metrics.*
    Record                      metric_source ${HOSTNAME}


# =============================================================================
# OUTPUTS - Send to Aggregation Layer
# =============================================================================

# Primary: Loki (Log Aggregation & Search)
# Lower memory footprint, great for distributed systems
[OUTPUT]
    Name                        loki
    Match                       agent.*
    Host                        loki.internal
    Port                        3100
    # URI for logs
    Uri                         /loki/api/v1/push
    # Labels from structured data
    Label                       agent_id
    Label                       component
    Label                       level
    Label                       correlation_id
    Label                       swarm_id
    # Batch settings
    Batch_Size                  100
    Batch_Wait                  10s
    # Retry strategy
    Retry_Limit                 2
    # Use correlation_id as trace_id for distributed tracing
    trace_key                   correlation_id
    # Compression
    net.compress                gzip
    # HTTP/HTTPS
    http_user                   ${LOKI_USER:-user}
    http_passwd                 ${LOKI_PASS:-password}


# Secondary: S3-compatible storage for long-term retention
[OUTPUT]
    Name                        s3
    Match                       agent.*
    bucket                      infrafabric-logs
    region                      us-east-1
    endpoint                    ${S3_ENDPOINT:-s3.amazonaws.com}
    s3_key_format               /logs/%Y-%m-%d/%H/%M/%S-$UUID.json.gz
    # Credentials from environment
    aws_auth_type               ${AWS_AUTH_TYPE:-role}
    # Compression
    compression                 gzip
    # Buffer settings
    total_file_size             100M
    upload_chunk_size           10M
    # Retry on failure
    retry_limit                 2
    # Only store errors/warnings long-term
    Condition                   Key_value_matches level (ERROR|FATAL|WARN)


# Tertiary: Elasticsearch (Rich Querying, Advanced Analytics)
# Optional - use if you need advanced aggregations or Kibana dashboards
[OUTPUT]
    Name                        es
    Match                       agent.*
    Host                        elasticsearch.internal
    Port                        9200
    # Index naming
    Logstash_Format             On
    Logstash_Prefix             infrafabric
    Logstash_DateFormat         %Y.%m.%d
    # Include timestamp in index
    Generate_ID                 On
    # Type (deprecated in ES 7+)
    Type                        _doc
    # Bulk settings
    Bulk_Action                 index
    # Authentication
    HTTP_Auth                   elastic:${ELASTIC_PASS}
    # TLS
    tls                         off
    tls.verify                  off
    # Retry
    Retry_Limit                 2


# Stdout for development/debugging (only in dev environment)
[OUTPUT]
    Name                        stdout
    Match                       agent.*
    Condition                   Key_value_matches environment development
    Format                      json_lines


# System logs to Loki
[OUTPUT]
    Name                        loki
    Match                       system.*
    Host                        loki.internal
    Port                        3100
    Uri                         /loki/api/v1/push
    Label                       source
    Label                       level


# Metrics to Prometheus-compatible endpoint (optional)
[OUTPUT]
    Name                        prometheus_exporter
    Match                       metrics.*
    host                        0.0.0.0
    port                        2021
    Labels                      service=infrafabric


# =============================================================================
# OPTIONAL: Log Rotation in Fluent Bit
# =============================================================================

# If local buffering needed before sending to remote
[OUTPUT]
    Name                        stackdriver
    Match                       agent.*
    # For Google Cloud Logging (optional backend)
    google_service_credentials  /etc/fluent-bit/gcreds.json
    resource_labels             project_id=${GCP_PROJECT_ID}
    resource_labels             location=${GCP_REGION}
    resource_labels             cluster_name=${CLUSTER_NAME}
    Retry_Limit                 2
